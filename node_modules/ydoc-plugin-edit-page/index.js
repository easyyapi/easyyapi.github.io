const fs = require('fs');
const path = require('path');

const editJSON = {};

module.exports = {
  init: function () {
    this.addAsset('./edit_json.js', 'js')
  },
  page: function (page, book) {
    if (page.type === 'md') {
      page = Object.assign({}, page);
      const dist = this.config.dist;
      const pagePath = page.distPath.substr(dist.length);
      const srcPath = page.srcPath.substr(dist.length);
      const prefix = this.config.pluginsConfig['edit-page'].prefix;
      editJSON[pagePath] = srcPath;
      editJSON.prefix = prefix;
    }
  },
  finish: function () {
    const dist = this.config.dist;
    fs.writeFileSync(path.resolve(dist, './edit_json.js'), `window.ydoc_plugin_edit_json = ${JSON.stringify(editJSON, null, 2)}`)
  },
  assets: {
    dir: './assets',
    js: 'edit.script.js',
    css: 'editPage.css'
  }
}